---
title: "Krankheitslast durch Umgebungslärm in Hessen"
author: "Matthias Lochmann"
format: pptx
editor: visual
---

markdown Kopieren

---
title: "Healthiar Hessen: Lärmbelastung und Gesundheitsauswirkungen"
author: "Matthias Lochmann"
format:
  html:
    toc: true
    code-fold: true
    code-line-numbers: true
---

```{r setup, include=FALSE}
# Bibliotheken laden
rm(list = ls())
#falls aktuellster healthiar gewünscht; diese Lade-Methode funkioniert u.U. nicht auf allen Rechnern
# library(remotes)
# remotes::install_github(repo = "SwissTPH/healthiar", build_vignettes = TRUE)
# hier Standardmethode
library(tidyverse)
library(healthiar)
library(readxl)
library(janitor)
library(purrr)
```

## Einführung

Dieses Dokument analysiert die Lärmbelastung in Hessen und berechnet die damit verbundenen Gesundheitsauswirkungen. Die Analyse basiert auf Daten des HLNUG und ETCHE-Funktionen.

## Daten laden und vorbereiten

ETCHE-, HLNUG- sowie Destatis Daten laden.

```{r load-data}
# ETCHE Input laden
functionsETCHE <- read_excel("data/ETCHE/functionsETCHE.xlsx") %>%
  mutate(
    ERF = str_replace_all(ERF, "threshold", as.character(threshold)),
    DW = as.numeric(DW)
  )

# HLNUG-Expositionsdaten laden
dat_str <- read_excel(
  "data/Expositionsdaten/HE_ULK2022StatistikGesamt_20240704.xlsx",
  sheet = "Straßenlärm",
  skip = 1,
  n_max = 426
)
dat_flug <- read_excel(
  "data/Expositionsdaten/HE_ULK2022StatistikGesamt_20240704.xlsx",
  sheet = "Fluglärm",
  skip = 1,
  n_max = 35
)
dat_ind <- read_excel(
  "data/Expositionsdaten/HE_ULK2022StatistikGesamt_20240704.xlsx",
  sheet = "Industrielärm",
  skip = 1,
  n_max = 6
)

# Gemeinde- und Kreisnamen laden
kreise_daten <- read_delim(
  "./data/Gebietstabellen/kreise_daten.csv",
  delim = ";",
  escape_double = FALSE,
  trim_ws = TRUE
)
gemeinden_daten <- read_delim(
  "data/Gebietstabellen/gemeinden_daten.csv",
  delim = ";",
  escape_double = FALSE,
  trim_ws = TRUE
)
```

## Expositionsdaten aufbereiten

Möglichst alle Daten sollen im long-format verfügbare sein.

```{r prepare-exposure}
# Funktion zum Aufbereiten der Expositionsdaten
lang_machen <- function(data, welche_exp) {
  data %>%
    janitor::clean_names() %>%
    select(contains("gemeinde") | contains("belasteter")) %>%
    setNames(str_replace(names(.), "_bis_[0-9]*", "")) %>%
    pivot_longer(
      starts_with("anzahl"),
      names_sep = "_ab_",
      names_to = c("metric", "L_Untergrenze"),
      values_to = "population"
    ) %>%
    mutate(
      L_Untergrenze = as.numeric(L_Untergrenze),
      L_central = L_Untergrenze + 2,
      .keep = "unused"
    ) %>%
    mutate(
      kreis = str_sub(gemeinde_kennziffer, start = 1L, end = 3L),
      metric = str_remove(metric, "anzahl_belasteter_"),
      metric = str_replace_all(metric, "l_night", "lnight"),
      source = welche_exp
    ) %>%
    replace_na(list(population = 0))
}

dat_l <- lang_machen(dat_str, "road") %>%
  bind_rows(lang_machen(dat_flug, "air")) %>%
  bind_rows(lang_machen(dat_ind, "industry")) %>%
  left_join(
    kreise_daten %>%
      filter(Bundesland_Code == "06") %>%
      select(Kreis_Code, Kreis_Name) %>%
      rename(kreis = Kreis_Code, name_kreis = Kreis_Name),
    by = "kreis"
  )
```

## Gesundheitsauswirkungen berechnen

Funktion zur Berechnung der Gesundheitsauswirkungen

```{r calc-health-impacts}
calc_kreis_ar_impact <- function(dat) {
  ifelse(dat %>%
           select(risk_type, threshold, ERF) %>%
           unique() %>%
           nrow() > 1,
         stop(
           "Function calc_kreis_ar_impact expects a data frame with a single ERF function!"
         ),
         NA)
  dat %>%
    {
      healthiar::attribute_health(
        approach_risk = "absolute_risk",
        pop_exp = .$population,
        exp_central = .$L_central,
        cutoff_central = first(.$threshold),
        erf_eq_central = first(.$ERF),
        geo_id_micro = .$name_stadt_gemeinde,
        geo_id_macro = .$name_kreis,
        dw_central = .$DW,
        duration_central = 1
      )
    } %>%
    .$health_detailed %>%
    .$results_raw %>%
    mutate(
      source = dat$source[1],
      metric = dat$metric[1],
      outcome = dat$outcome[1]
    )
}


```

## Expositionsdaten und ERF-Funktionen zusammenführen

```{r merge-exposure-erf}
dat_exp_ERF <- dat_l %>%
  left_join(functionsETCHE, by = c("source", "metric"), relationship = "many-to-many") %>%
  mutate(threshold = replace_na(threshold, 0))
```

## Gesundheitsauswirkungen für verschiedene Lärmquellen berechnen

Hier beispielshaft für einige Gesundheitsauswirkungen: HA, HSD, Leseverständnis.

```{r health-impacts-road-air}
HA_road_res <- dat_exp_ERF %>%
  filter(source == "road", metric == "lden", outcome == "High noise annoyance") %>%
  calc_kreis_ar_impact(.)

# Straßenlärm: Hohe Schlafstörung
HSD_road_res <- dat_exp_ERF %>%
  filter(source == "road", metric == "lnight", outcome == "High sleep disturbance") %>%
  calc_kreis_ar_impact(.)

# Fluglärm: Hohe Lärmbelästigung
HA_air_res <- dat_exp_ERF %>%
  filter(source == "air", metric == "lden", outcome == "High noise annoyance") %>%
  calc_kreis_ar_impact(.)

# Fluglärm: Hohe Schlafstörung
HSD_air_res <- dat_exp_ERF %>%
  filter(source == "air", metric == "lnight", outcome == "High sleep disturbance") %>%
  calc_kreis_ar_impact(.)

# Fluglärm: Leseverständnis
Reading_air_res <- dat_exp_ERF %>%
  filter(source == "air", metric == "lden", outcome == "Reading Comprehension") %>%
  calc_kreis_ar_impact(.)
```

## Visualisierungen

Lärmbelastung in Hessen nach Kreisen

```{r plot-exposure-hessen}
dir.create("plots", showWarnings = F)

dat_l %>%
  ggplot(aes(x = L_Untergrenze, y = population, fill = name_kreis)) +
  geom_col() +
  facet_grid(metric ~ source) +
  labs(
    title = "Lärmbelastung in Hessen nach Kreisen, Quelle und Lärmmetrik",
    x = "Lärmpegel in dB",
    y = "Anzahl exponierter Personen"
  ) +
  guides(fill = guide_legend(title = "Kreis"))
ggsave("plots/exposition_hessen.png", width = 12, height = 8)
```

## Gesundheitsauswirkungen im Kreis Groß-Gerau

```{r plot-exposure-kreis-gg}
outcome_all <- HA_road_res %>%
  bind_rows(HSD_road_res) %>%
  bind_rows(HA_air_res) %>%
  bind_rows(HSD_air_res) %>%
  bind_rows(Reading_air_res)

kagzrm_kreise <- c("Darmstadt-Dieburg", "Groß-Gerau", "Main-Taunus-Kreis", "Offenbach")

outcome_all %>%
  filter(geo_id_macro %in% kagzrm_kreise) %>%
  ggplot(aes(x = source, fill = geo_id_macro, y = impact)) +
  geom_col() +
  facet_grid(. ~ outcome) +
  labs(
    title = "Verteilung DALY durch Lärm-bedingte Gesundheitsauswirkungen für die Kreise der KAGZRM",
    x = "Lärmquelle",
    y = "Attributable Krankheitslast [DALY]"
  ) +
  guides(fill = guide_legend(title = "Kreis"))
ggsave("plots/DALY_FlugStraße_KreiseKAGZRM.png", width = 12, height = 8)
```
