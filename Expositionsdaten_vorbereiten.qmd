---
title: "Expositionsdaten vorbereiten"
author: "Matthias Lochmann"
format: docx
editor: visual
execute:
   echo:  false
   warning: false
---

```{r front_matter}
rm(list = ls())
library(tidyverse)
library(readxl)
library(flextable)

```

## Datenformate

Lärmexpositionsdaten werden häufig als Exceltabellen z.B. von Landes- oder Bundesämtern bereitgestellt. Deren jeweiliges Format ist oft ähnlich, unterscheidet sich aber in vielen Details. Um die Daten gut verarbeiten zu können, werden sie hier eingelesen und schön formatiert abgespeichert.

## Vorliegende Dateien

Metadatentabelle mit flextable:

```{r lese_metadaten}

meta <-
  read_delim(
    "data/Expositionsdaten/MetadatenExpositionsdaten.csv",
    delim = ";",
    escape_double = FALSE,
    trim_ws = TRUE
  ) |>
  dplyr::mutate(quelle = factor(quelle),
                kartierungsumfang = factor(kartierungsumfang))

read_colnames <- function(path) {
  readr::read_csv(path, col_names = FALSE, show_col_types = FALSE) |>
    dplyr::pull(1)
}

```

In der @tbl-metadaten liegen die Metadaten.

```{r metadatentablee}
#| label: tbl-metadaten
#| tbl-cap: "Die Metadaten, mit Hilfe derer die Expositionsdaten eingelesen werden"
#| tbl-colwidths: [60,40]
meta %>% 
  mutate(
    across(
      where(is.character),
      ~ str_trunc(.x, 30,side="left")
    )
  ) %>% 
  knitr::kable()
```

## Verarbeitung

Mit diesen Metadaten wird alles eingelesen und gleich in ein gut weiterverarbeitbares "long format" transformiert.

```{r einlesen_verarbeiten}

read_one_dataset <- function(meta_row) {
  col_names <- read_colnames(meta_row$spaltennamen)
  readxl::read_excel(
    path  = meta_row$pfad,
    sheet = meta_row$tabellenblatt,
    skip  = meta_row$zeilen_weglassen,
    n_max = meta_row$zeilen_gesamt,
    col_names = col_names
  ) %>%
    mutate(geoschluessel_stellen = meta_row$geoschluessel_stellen)
}
## Expositionsdaten schön machen

lang_machen <- function(data) {
  data %>%
    select(contains("gemeinde") |
             contains("belasteter") | contains("geoschluessel")) %>%
    setNames(str_replace(names(.), "_bis_[0-9]*", "")) %>%
    pivot_longer(
      starts_with("anzahl"),
      names_sep = "_ab_",
      names_to = c("metric", "l_untergrenze"),
      values_to = "exponierte"
    ) %>%
    mutate(
      l_untergrenze = as.numeric(l_untergrenze),
      l_central = l_untergrenze + 2,
      .keep = "unused"
    ) %>%
    mutate(metric = str_remove(metric, "anzahl_belasteter_")) %>%
    replace_na(list(exponierte = 0)) #%>% 
    # mutate(gemeinde_kennziffer=
    #          gemeinde_kennziffer %>% 
    #          str_sub(
    #            start=geoschluessel_stellen - 5L,
    #          ))
}


for (i in 1:nrow(meta)) {
  metadatazeile <- meta[i, ]
  cat("Lese ",paste(metadatazeile),", Sheet",metadatazeile$tabellenblatt,"....\n")
  ds <- read_one_dataset(metadatazeile) %>% 
    mutate(gemeinde_kennziffer=as.character(gemeinde_kennziffer))
  cat("Habe",nrow(ds)," Zeilen gelesen.")
  ds<-ds %>%
    lang_machen() %>%
    mutate(
      bundesland_code        = metadatazeile$bundesland_code,
      quelle            = metadatazeile$quelle,
      kartierungsumfang = metadatazeile$kartierungsumfang
    )
  cat("... und56 ins lange Format formatiert.\n")
  if (i == 1) {
    data <- ds
    cat(" dataframe namens data geschaffen; hat",nrow(data),"Zeilen.\n")
  } else {
    data <- bind_rows(data, ds)
    cat(" und angehängt. Insgesamt sind es jetzt",nrow(data),"Zeilen.\n")
  }
  
}
```

## Geocode vereinheitlichen

```{r}
gkz_vereinheitlichen <- function(data) {
  data %>%
      mutate(
      gemeinde_kennziffer_kompl = str_sub(
        gemeinde_kennziffer,
        start = geoschluessel_stellen - 5L
      ) %>% 
        paste0(bundesland_code,.)
    )
}
bla<-data %>% 
  gkz_vereinheitlichen()

```

## Statistiken über eingelesene Daten

Hier eine Statistik

```{r statistiken}

anzahl_expositionen<-data %>% 
  group_by(name_stadt_gemeinde,quelle, kartierungsumfang, metric) %>% 
  summarise(total_exponierte = sum(exponierte),Anzahl_Pegelbaender=n())

anzahl_expositionen %>%
  ungroup() %>% 
  slice_sample(n=5) %>% 
  flextable::qflextable()

```
